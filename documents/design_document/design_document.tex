%% The comment character in TeX / LaTeX is the percent character.
%% The following chunk is called the header

\documentclass{article}	% essential first line
\usepackage{times}		% this uses fonts which will look nice in PDF format
\usepackage{graphicx}		% needed for the figures
\usepackage{url}
\usepackage{adjustbox}
\usepackage{amsmath}
\usepackage{listings}
\usepackage{multicol}
\usepackage{color}
\usepackage{multirow}
\usepackage{array}
\usepackage{tabularx}

%% Set the folder where pictures are located
\graphicspath{ {images/} }

%% Here I adjust the margins

\oddsidemargin -0.5in%-0.25in		% Left margin is 1in + this value
\textwidth 7.5in		% Right margin is not set explicitly
\topmargin 0in			% Top margin is 1in + this value
\textheight 9in			% Bottom margin is not set explicitly
\columnsep -0.25in %0.25in		% separation between columns

% set listing settings
\lstset{language=C, 
		numbers=left,
		frame=single,
		tabsize=2,
		breaklines=true,
		commentstyle=\color{red}}

%% Define the fields to be displayed by a \maketitle command
\author{Dee, Timothy\\
    \texttt{timdee@iastate.edu}
    \and
    Long, Justin\\
    \texttt{jlong@iastate.edu}
    \and
    McDonnel, Brandon\\
    \texttt{bmcdonnel@iastate.edu}
}

\title{Remotely Connected Electric Field Generator\\
for Particle Separation in a Fluid \\
\large{Team May1612}}

%%
%% Header now finished
%%

\begin{document}		% Critical
\thispagestyle{empty}		% Inhibit the page number on this page
\maketitle			% Use the \author, \title and \date info

\begin{multicols}{2}

\abstract{
This document details the design and implementation of a
remotely connected electric field generator.
The goal of this design is to provide an easy interface for
manipulating the output voltage and frequency of a circuit
remotely in order to generate an electric field.
This electric field,
when applied to a fluid over a long period of time
will cause particles in the fluid to separate.
The hardware and software components used to accomplish
the aforementioned goal are described in detail.
}

% Make an argument for why this project is:
% useful
% necessary
% novel
\section{Introduction}
New research has shown that certain particles may be separated from fluids through dielectrophoresis.
This process involves applying an electric field to a fluid.
The field may be manipulated in order to attract or repel certain particles.
The particles the electric field will attract or repel depends on
characteristics of the electric filed which may be controlled
by varying the voltage and frequency of the electronics driving the field.

This technology has many useful applications in health care.
The proposed end use of this equipment is
for separating particles bodily fluids,
such as spinal fluid.
Such medial applications could be useful
in testing or filtering these fluids.

Being capable of separating though the
application of an electric field would represent
an advancement over existing solutions.
It introduces a new method of testing which
could be more precise when compared
to existing technologies.
% TODO

\section{Project Definition}
In our implementation, an electric field is applied 
to two metal plates.
Through varying the voltage and frequency
applied to these plates, 
the properties of the electric field may be changed.

Our job is to construct a system 
containing an electronic circuit capable of providing
the necessary voltages and frequencies required 
to drive a pair of metal plates.
This system must enable the circuit to be controllable 
through the use of a web interface.
In addition, a small form factor must be maintained.

The system must be able to generate up to a 60 V peak-peak sine wave with
user-controlled variable frequency from 10 kHz to 1 MHz. 
% TODO

\subsection{Deliverables}
There are four items which must be constructed for this project:
% TODO list the components which must be constructed

For the analog circuit components,
functionality of the circuit will be tested
using an oscilloscope to verify 
the requirements have been satisfied.
This method can also be used to ensure 
the output signal contains minimal amounts of noise and distortion. 

% TODO if we don't get to the research component of the project,
% we should remove this
The construction of this device is the first phase of the project.
After the completion of this component,
the device will be used 
to experiment with particle separation in various fluid types.
These experiments constitute the remainder of the project.
% TODO add adam's name
For these experiments our advisor at Minetronix, John Pritchard, 
will be the main source of guidance and testable material. 

\subsection{Constraints}
Constraints on this project fall within the size, voltage, and portability domains.

The size requirements of this project are directly related 
to the portability of the final design.
The design requirements specify this system must be easily and quickly
moved around from one workstation to another.
The maximal allowed size is approximately 
the size of a backpack 
with smaller sizes being more desirable
but not explicitly required.
With the electronics currently being used,
these requirements will easily be met.

Another constraint arises from the power supply requirements.
The power supply must deliver at least 60V DC in order to feed the amplifier circuit. 
Due to this, the final design requires a power brick
similar to one which would be used to charge a laptop.
Importantly, this would require the device to be plugged into a wall outlet.
This is not seen as an issue.
Every location this device will operate 
will most likely have other equipment with similar power requirements.

In order to use this system,
there are other items which are required
apart from the device itself. 
The first requirement is a network connection between the device and a computer.
This connection is necessary to be able to interact with the web server hosted on the Raspberry Pi. 
Without a computer to interact with this system there is no practical means of utilizing the device's functionality. 
The next requirement, as mentioned above, is a network connection to the Raspberry Pi. 
The third system requirement is a standard wall outlet
to accommodate the power needs of the system. 

\subsection{System Analysis}
A user will interface with this system though the web interface.
This web interface may be accessed by
typing the IP address of the device into a standard web browser.
The interface will allow the user to choose the values for Voltage and Frequency.
Once these values have been entered,
update scripts on the Raspberry Pi
will set the voltage and frequency output of the circuit
according to the values entered.

%\section{Block Diagram}
\begin{figure*}[!hbt]
\begin{center}
\includegraphics[width=1.0\textwidth,keepaspectratio]{block_diagram.png}
\end{center}
\caption{Block Diagram provides an overview of the system components.}
\end{figure*}

\section{Functional Decomposition}
This system has four fundamental functional blocks.
These include the 
Web Interface, 
Raspberry Pi, 
Minigen Signal Generator, and
Amplifier Circuit.
The project will be described in terms of 
these components and
their interactions.

\subsection{Web Interface}
The web interface is hosted on the Raspberry Pi using an Apache web server.
This web server displays an interface which allows the user to
set a voltage and frequency output by the system. 
The interface is simple and interactive,
implemented using cgi-scripts on the Apache web server.

Our implementation provides several functionalities.
Among these are
the ability to set:
voltage and frequency,
sine or triangle or square waveforms,
and the ability to set a voltage and frequency for an amount of time.
The table displayed
in the figure below
provides the ability to set voltage and frequency for the number
of minutes specified.
The "Go" button will cause the first
voltage and frequency to be set for the corresponding amount of time.
After the time has expired,
the next voltage and frequency will be set for the corresponding amount of time.
This process continues until the table entries are completed or
the user presses the "Stop" button.

\begin{center}
\includegraphics[width=0.45\textwidth,keepaspectratio]{491_web_interface_good.png}
\end{center}

\subsection{Web Server}
The primary function of the web server is to communicate with the Raspberry Pi.
This is the primary method of control afforded 
to the user by the system. 
The web pages displayed by the server
have the ability to control the voltage and frequency output by the circuit.

Displaying this interface is accomplished by 
running an Apache web server on the Raspberry Pi. 
When the user clicks update, the server could executes 
a cgi-script performing the update functionality.

\subsection{Raspberry Pi}
The Raspberry Pi will act as the bridge between the user and the circuit.
The Raspberry Pi will host a web server allowing the user to interact with the system.
Based on the results of this user interaction, 
the Raspberry Pi will update the state of the GPIO pins.
The GPIO pins connect to a circuit causing the output to change based on their state. 

In addition to hosting the web server the Raspberry pi is used to
communicate with the 
Minigen Signal Generator and 
amplifier circuit.
This communication is accomplished via 
the Raspberry Pi's SPI interface and
GPIO pins respectively.

%TODO

%TODO insert Raspberry Pi connection diagram
\begin{center}
\includegraphics[width=0.45\textwidth,keepaspectratio]{rpi_connection.png}
\end{center}

\subsection{Minigen}
The Minigen Function Generator device controls the frequency output by the circuit.
Varying the frequency is accomplished 
by writing to registers present on the Minigen.
This communication is completed over SPI between
the Raspberry Pi and the Minigen.
The frequency produced is a function of
the values contained in the Minigen's frequency registers.

The Minigen outputs a waveform 
from -0.5V to 0.5V. 
This waveform may be a triangle, square, or sine wave.
The voltage output by the Minigen is not variable.
Given that the design specification requires a variable voltage,
the voltage needs to be adjusted separately.
Accordingly, the output of the Minigen 
is supplied to the input of the amplifier circuit.

The Minigen is controlled by setting five registers,
two registers for frequency, 
two for phase shift and 
one as a control. 
There exists no need for phase shifting
to meet the design requirements, 
however the frequency and control registers
are needed. 
By having two frequency registers,
data can be sent to one register while it is not in use,
followed by a write to the control register to use this register.
This allows for a nicer gradient, 
because the frequency will not change until the entire frequency register is written. 
The control register also allows for changing between sine, square and triangle waveforms.
In the event that the frequency needs to be finely adjusted,
this system utilizes the functionality of the control register
to modify the way in which writes to the frequency registers are received.
The way writes are received by the frequency registers 
can be varied between two modes.
In one mode,
two consecutive 14-bit writes to a frequency register are used.
In the other mode,
one write to the lower 14-bits of the 28-bit frequency register is used.
This functionality affords the ability to accurately dial in small changes to the register values quickly.

Until this point,
several functional benefits of the Minigen Signal Generator have been discussed.
An additional benefit which 
increases the practicality of this solution is the Minigen's small form factor.
The small chip size 
allows the Minigen to fit easily into a small case 
with the Raspberry Pi.
This is consistent with the system's requisite small footprint.

\subsection{Amplifier Circuit}
As mentioned in the previous section,
the output of the Minigen Function Generator
is applied to the amplifier circuit as input.
The amplifier also receives input from 
the GPIO pins of the Raspberry Pi.
These GPIO pins act as switches which help to control the output voltage.
Based on these inputs 
the amplifier circuit manages the overall 
voltage and frequency output.

The project requirements state that the system must 
generate signals which range from $1V_{pp}$ to $60V_{pp}$. 
To accomplish this,
various circuit components were used to accomplish the amplification.
The overall scheme is to split the output voltages into
three different ranges.
One component is used to adjust the voltage within each of the ranges while
other comp are used to change the range the voltage adjuster is acting within.

\subsubsection{Summing Amplifier}
The summing amplifier is the last component
in the amplifier circuit.
The overall voltage range which needs to be produced is divided into three segments.
Each of these segments have their output connected as
input to the summing amplifier.
One of the segments utilizes a programmable gain amplifier(PGA)
to vary the voltage within one third of the range.
While the relays are used to increase the voltage by one third of the overall voltage range when they are turned on.

The advantage of this design is that
it allows for three times the number of voltage steps
allowed for by a single PGA.
This could also be accomplished by using multiple PGA's.
Utilizing the relays in increase the voltage instead of additional PGA's
allows for reduced software and hardware complexity.

\subsubsection{Relay}
The overall voltage range,
$1V_{pp}$ to $60V_{pp}$,
is divided into three $20V_{pp}$ ranges.
The relay's have two states,
on and off,
which allow for moment between the ranges.
When on,
the input the the Amplifier circuit is amplified to $20V_{pp}$.
This $20V_{pp}$ signal is input to the summing amplifier.
There are two of these relay circuits used.
Turning them on or off allows the voltage range to be chosen.
These relay circuits are controlled by 
GPIO pins on the Raspberry Pi.

\subsubsection{Programmable Gain Amplifier(PGA)}
There are three $20V_{pp}$ voltage ranges.
Which range being acted in is chosen by the relay circuits.
Within a given range,
however,
a PGA is used to control the voltage output.
In our implementation,
a PGA has control over a $20V_{pp}$ range.
The PGA has 8 steps within this range.
This Device is controlled by 
the SPI interface on the Raspberry Pi.

%TODO

%TODO insert a diagram of the amplifier circuit
%\begin{center}
%\includegraphics[width=0.45\textwidth,keepaspectratio]{amplifier_circuit.png}
%\end{center}

\section{Software Components}
The web interface displayed by
the web server hosted on the Raspberry Pi
is the user's window into the system.
Through this interface,
the user can seamlessly control various
components of the system cause 
the desired voltage and frequency 
to be produced.
Previously covered are
the hardware components used to accomplish this.
This section describes the software counterparts
used to control the hardware.

% code layout diagram
%\begin{figure}[!hbt]
\begin{center}
\includegraphics[width=0.47\textwidth,keepaspectratio]{script_layout.png}
\end{center}
%\caption{Script layout according to work delegation.}
%\label{fig_script_layout}
%\end{figure}

\subsection{Modifying Frequency}
The frequency output by the circuit is controlled 
by the Minigen Function Generator.
Thus the software components used to 
modify the output frequency
are in essence
a method of communication with the Minigen device.

The process begins when the user 
enters a new frequency value into the web interface
and clicks the "update" button.
The \textit{update.py} script parses 
the parameters contained in the URL
resulting from the user's update request.
These parameters are than
passed on to \textit{update\_voltage\_frequency.py}
which determines the appropriate update procedure 
with which to call \textit{minigen.py}.

%TODO explain how minigen.py works in detail

\subsection{Controlling Voltage}
\subsubsection{Relay}
%TODO explain how we decide whether to turn relays on or off

\subsubsection{Programmable Gain Amplifier(PGA)}
%TODO explain how we choose the value to set the pga
%TODO explain how we modify the value of the pga


\section{Cost Considerations}
The monetary cost of this project is fairly low. 
The precise costs of components in the future are unknown, but
a table 
of current prices has been provided
along with the necessary quantity of each component.
The projected cost of op-amps and other electronic components is minimal. 
The largest expenditure of the project is
the purchase of the 
Raspberry Pi 2 and 
Minigen Function Generator. 
The Raspberry Pi 2 package is currently priced at \$99.95 and
the Minigen cost at \$29.95.
Thinking conservatively the cost of the major hardware will be \$129.90. 
In addition, the cost of 
a resistor kit, 
a capacitor kit, and 
a handful of op-amps 
must be included.

The Minigen Function Generator may be acquired from 
\textit{http://www.sparkfun.com}.
This website also provides 
a resistor kit for \$7.95 
which includes all necessary resistors. 
From this same website,
individual capacitors may be purchased
at a rate of \$0.25 per capacitor.
Operational amplifiers may also be purchased at
a rate of \$0.95 per amplifier.
Given this,
the total cost is approximated at \$152.35. 
This is far below the maximum allotted funds of \$1,000
specified in the project description.

%TODO table of costs
\begin{center}
    \begin{tabularx}{0.4\textwidth}{|X|X|X|X|}
        \hline

        \textbf{Item} &
        \textbf{Part Number} &
        \textbf{Quantity} &
        \textbf{Price(\$)} \\
        \hline

        \textbf{Raspberry Pi 2 Kit} &
        \textbf{-} &
        \textbf{1} &
        \textbf{99.95} \\
        \hline

        \textbf{Minigen Function Generator} &
        \textbf{AD9837} &
        \textbf{1} &
        \textbf{29.95} \\
        \hline

        \textbf{Resistor Pack} &
        \textbf{-} &
        \textbf{1} &
        \textbf{7.95} \\
        \hline

        \textbf{Capacitor Pack} &
        \textbf{-} &
        \textbf{1} &
        \textbf{5.00} \\
        \hline

        \textbf{Op Amps} &
        \textbf{-} &
        \textbf{8} &
        \textbf{9.50} \\
        \hline

        \textbf{Total} &
        \textbf{-} &
        \textbf{-} &
        \textbf{152.35} \\

        \hline
    \end{tabularx}
\end{center}

\section{Redesigned Components}
In an introductory economics class,
it is common that students are taught about sunk costs.
Sunk costs refer to those costs which
have already been incurred and
cannot be recovered.
These classes teach that suck costs should not
be considered in making future investments.
In other words,
one should not ask themselves the extent of 
current investment down a particular path.
Rather, one should ask,
given what is known now,
which investment is more intelligent.

While economics classes teach about sunk costs in
the context of monetary investment,
the same logic may be applied to other domains.
In the case of this project,
the investment capital is time and energy.
Regardless of how much energy has been invested
in a particular design,
it is necessary to evaluate alternatives to that design.
If these alternatives than look better
given what is known about both designs
than the design should be modified accordingly
to fit the alternative design.

Throughout the course of this project,
several components needed to be redesigned.
Below is some mention of these designs and
the issues encountered which motivated deviation from them.

\subsection{Frequency Control}
The Raspberry pi is capable of producing square waves by turning the GPIO pins on and off rapidly. We can use this functionality to produce a wave of the frequency indicated by the user. The GPIO pins can also be used to set the voltage by communicating with the circuit how much the output waveform should be amplified. The downside to this approach is the analog circuit component will need to be more complex. The analog circuit needs to output a sine wave. With this approach we would need to integrate the square wave produced by the GPIO pin.

There exist alternatives to using the GPIO pins to generate a signal with a given frequency. We could instead use the GPIO pins on the raspberry pi to communicate with a small signal generator, such as \textit{sparkfun.com}‘s Minigen Function Generator. This would make programming the Raspberry pi more complex, but could lead to higher quality waveforms. Producing a sine wave using the Minigen signal generator is likely to to produce fewer distortions compared to integrating a square wave produced by the RPI’s GPIO pin twice. 

\subsection{Voltage Control}
\subsubsection{Digital Potentiometer}
The output of the digital potentiometer has 128 steps. This Translates into our ability to set 128 different gains on our amplifier. We will need multiple stages of amplifier to go between 1 and 60 Vpp. The most prominent reason for this is due to the gain bandwidth of the op-amps. We will not be able to have a large gain while still producing a frequency of 1Mhz.

One problem we foresee with the digital potentiometer is that it cannot handle a large amount of power. This may force us to come up with different amplifier configurations, or use the digital potentiometer in a different way. Another way we could possibly use this device is as an attenuator at the input to the amplifier.

Another problem which might arise with the digital potentiometer is the capacitance of the wiper. We don’t have any context for understanding how much this will affect the output signal. According to some preliminary calculations, we have determined that the capacitance will not present a large problem.
This design was replaced by a programmable gain amplifier.

\subsubsection{Transistor switch}
The overall voltage output by the amplifier circuit
varies between $1V_{pp}$ to $60V_{pp}$.
In our implementation,
this range is segmented into three parts of $20V_{pp}$ each.
Each of the three segments are input to a summing amp to
create up to $60V_{pp}$ overall.

A PGA is used for fine adjustment of one $20V_{pp}$ range while
the other two ranges are either $20V_{pp}$ or $0V_{pp}$.
In other words,
there ranges are turned on or off.

The original design for turning on and off the ranges
required that a BJT transistor switch circuit be used.
The intent was for this circuit to have either $20V_{pp}$ or $0V_{pp}$
depending on a GPIO pin from the Raspberry Pi.
This design did not work as intended.
Even when the transistors were off there was still current leakage.
This current leakage caused problems when input to the summing amplifier.
For this reason, the BJT transistor switch ciruits were replaced with solid state relays.

\section{Known Issues}
The current solution has some noteworthy issues
which need to be addressed.
Issues are defined as unintended issues of unknown origin.
Possible reasons for each of the issues are discussed as
well as the accommodations made in this implementation to lessen their impact.
Potential solutions are also mentioned.

\subsection{B23}
In the current prototype,
there is an ongoing issue with the Minigen Function Generator.
This device works as expected in most cases.
The exception occurs when bit 23 of either frequency register
is set high.
This case will cause the Minigen device to produce a $4Mhz$ sine wave.
There is potential that the specific Minigen device used 
is responsible for this bug.
Further testing is required.

The solution currently implemented is
to detect conditions which will cause the error
and avert these situations problematically.
Whenever bit 23 is set to high in a frequency register write,
the current implementation sets bit 23 to low
and sets all less significant bits to high.
%TODO

%\section{Conclusion}
%TODO

\end{multicols}

% go to next page
\pagebreak

\section{Appendix}
%TODO modify timeline
\subsection{Project Timeline}
% Timeline in table format
\begin{center}
    \begin{tabularx}{\textwidth}{|X|X|X|}
        \hline
        
        \textbf{Item} & 
        \textbf{Completion Date} & 
        \textbf{Description} \\
        \hline

        Project Plan & 
        01 Oct. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Create a project plan which specifies the pieces of the project.
        } \\
        \hline

        Project Design & 
        15 Oct. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Complete a detailed design of each component of our project. Assign people to work on the various pieces of the project.
        } \\
        \hline

        Design Web Interface & 
        01 Nov. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Design and build web interface.
        Outline code for Communications with Minigen and Digital Potentiometers.
        } \\
        \hline

        Hardware Communications and Design & 
        15 Nov. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Get communications working between Raspberry Pi, Minigen, and Digital Potentiometers.
        } \\
        \hline

        Prototype Completion & 
        01 Dec. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Take final steps testing prototype. Device should be able to do everything in specification.
        } \\
        \hline

        Senior Design I Presentation & 
        15 Dec. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Present a working prototype of our project.
        } \\
        \hline

        Begin Experimentation Component & 
        01 Jan. 2015 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Begin working on Research component of the project.
        } \\
        \hline

        Continue Experimentation & 
        01 Feb. 2016 - 05 May. 2016 & 
        \multicolumn{1}{|p{12cm}|}{\centering 
        Use the project to perform research.
        } \\
        \hline
    \end{tabularx}
\end{center}

%\subsection{Graphical Comprehension Aides}
%\begin{figure}[!hbt]
%\begin{center}
%\includegraphics[width=1.0\textwidth,keepaspectratio]{491_web_interface_good.png}
%\end{center}
%\caption{Web Interface}
%\end{figure}

%\subsection{Code Listing - HTML}
%\lstinputlisting[caption=Main HTML Page]{../www/index.html}

%\subsection{Code Listing - CGI Scripts}
% use listinputlisting to list files
%\lstinputlisting[caption=Update Website Script]{../cgi-bin/update.py}
%\lstinputlisting[caption=Update Voltage and Frequency Script]{../cgi-bin/update_voltage_frequency.py}
%\lstinputlisting[caption=Voltage Control Script]{../cgi-bin/voltageControl.py}
%\lstinputlisting[caption=Voltage Control Script]{../cgi-bin/voltage_regulator.py}
%\lstinputlisting[caption=Minigen Control Script]{../cgi-bin/minigen.py}
%\lstinputlisting[caption=PGA Control Script]{../cgi-bin/pga.py}
%\lstinputlisting[caption=Reset Script]{../cgi-bin/reset.py}

%\bibliographystyle{unsrt}	% Order by citation
%\bibliography{report}

\end{document}


